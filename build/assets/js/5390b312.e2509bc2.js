"use strict";(self.webpackChunkur_wave_doc=self.webpackChunkur_wave_doc||[]).push([[8],{1341:(e,n,i)=>{i.d(n,{A:()=>s});var t=i(6540),r=i(4848);const s=e=>{let{title:n="My Browser",url:i="http://localhost:3000",language:s="text",children:a}=e;const[o,l]=(0,t.useState)(!1);(0,t.useEffect)((()=>{const e=window.matchMedia("(prefers-color-scheme: dark)");l(e.matches);const n=e=>{l(e.matches)};return e.addEventListener("change",n),()=>e.removeEventListener("change",n)}),[]);const d={border:"1px solid #ccc",borderRadius:"10px",width:"100%",maxWidth:"100%",margin:"0",boxShadow:"0px 4px 8px rgba(0,0,0,0.1)",background:o?"#333":"#fff",color:o?"#fff":"#000"},c={background:o?"#222":"#f3f3f3",padding:"8px",display:"flex",alignItems:"center",borderTopLeftRadius:"8px",borderTopRightRadius:"8px",justifyContent:"space-between"},h={flexGrow:1,background:o?"#444":"#fff",padding:"4px 10px",margin:"0 10px",borderRadius:"6px",fontSize:"12px",color:o?"#ddd":"#333",textAlign:"center",border:"1px solid #ddd",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},g={padding:"16px",background:o?"#222":"#fff",overflow:"auto",color:o?"#fff":"#000"};return(0,r.jsxs)("div",{style:d,children:[(0,r.jsxs)("div",{style:c,children:[(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[(0,r.jsx)("span",{style:{background:"#ff5f57",width:"12px",height:"12px",borderRadius:"50%"}}),(0,r.jsx)("span",{style:{background:"#ffbd2e",width:"12px",height:"12px",borderRadius:"50%"}}),(0,r.jsx)("span",{style:{background:"#28c840",width:"12px",height:"12px",borderRadius:"50%"}}),(0,r.jsx)("span",{style:{fontSize:"14px",fontWeight:"bold",marginLeft:"8px"},children:n})]}),(0,r.jsx)("div",{style:h,children:i}),(0,r.jsx)("div",{style:{background:o?"#555":"#e0e0e0",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",fontWeight:"bold",color:o?"#ccc":"#666"},children:s})]}),(0,r.jsx)("div",{style:g,children:(0,r.jsx)("pre",{style:{margin:0},children:(0,r.jsx)("code",{className:`language-${s}`,children:a})})})]})}},6081:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"database/migrations","title":"Database Migrations Guide","description":"This guide covers the database migration tools and commands used in our platform. We use Entity Framework Core migrations to manage database schema changes across multiple contexts: LogDbContext, AppDbContext, and Identity Provider contexts (ConfigurationDbContext and PersistedGrantDbContext).","source":"@site/docs/database/migrations.md","sourceDirName":"database","slug":"/database/migrations","permalink":"/docs/database/migrations","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/database/migrations.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Database","permalink":"/docs/category/database"}}');var r=i(4848),s=i(8453);i(1341);const a={sidebar_position:1},o="Database Migrations Guide",l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"To install EF Core tools globally:",id:"to-install-ef-core-tools-globally",level:4},{value:"Using MigratorExecutor",id:"using-migratorexecutor",level:2},{value:"Features",id:"features",level:3},{value:"Using the Executor",id:"using-the-executor",level:3},{value:"Available options:",id:"available-options",level:4},{value:"For each option, you can configure:",id:"for-each-option-you-can-configure",level:4},{value:"Manual Command Usage",id:"manual-command-usage",level:2},{value:"Run generate hangfire migrations",id:"run-generate-hangfire-migrations",level:3},{value:"Run migration using cmd",id:"run-migration-using-cmd",level:3},{value:"Add new migration",id:"add-new-migration",level:3},{value:"Remove last generated migration",id:"remove-last-generated-migration",level:3},{value:"Apply pending migrations",id:"apply-pending-migrations",level:3},{value:"Generate SQL script for all migrations",id:"generate-sql-script-for-all-migrations",level:3},{value:"Generate SQL script for specific migrations",id:"generate-sql-script-for-specific-migrations",level:3},{value:"Database Contexts",id:"database-contexts",level:2},{value:"Our platform uses multiple database contexts:",id:"our-platform-uses-multiple-database-contexts",level:4},{value:"1. <strong>LogDbContext</strong>",id:"1-logdbcontext",level:3},{value:"2. <strong>AppDbContext</strong>",id:"2-appdbcontext",level:3},{value:"3. <strong>ConfigurationDbContext</strong>",id:"3-configurationdbcontext",level:3},{value:"4. <strong>PersistedGrantDbContext</strong>",id:"4-persistedgrantdbcontext",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Common issues and solutions:",id:"common-issues-and-solutions",level:4},{value:"1. Migration fails to apply",id:"1-migration-fails-to-apply",level:3},{value:"2. Conflicting migrations",id:"2-conflicting-migrations",level:3},{value:"3. MigratorExecutor.bat issues",id:"3-migratorexecutorbat-issues",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Naming Conventions",id:"1-naming-conventions",level:3},{value:"2. Version Control",id:"2-version-control",level:3},{value:"3. Testing",id:"3-testing",level:3},{value:"4. Deployment",id:"4-deployment",level:3}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"database-migrations-guide",children:"Database Migrations Guide"})}),"\n",(0,r.jsx)(n.p,{children:"This guide covers the database migration tools and commands used in our platform. We use Entity Framework Core migrations to manage database schema changes across multiple contexts: LogDbContext, AppDbContext, and Identity Provider contexts (ConfigurationDbContext and PersistedGrantDbContext)."}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:".NET Core SDK 8.0 or later"}),"\n",(0,r.jsx)(n.li,{children:"Entity Framework Core CLI tools"}),"\n",(0,r.jsx)(n.li,{children:"Access to the project's source code"}),"\n",(0,r.jsx)(n.li,{children:"Appropriate database permissions"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"to-install-ef-core-tools-globally",children:"To install EF Core tools globally:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dotnet tool install --global dotnet-ef\n"})}),"\n",(0,r.jsx)(n.h2,{id:"using-migratorexecutor",children:"Using MigratorExecutor"}),"\n",(0,r.jsxs)(n.p,{children:["The easiest way to run migrations is using our interactive ",(0,r.jsx)(n.code,{children:"MigratorExecutor.bat"})," script, located in the root of the project."]}),"\n",(0,r.jsx)(n.h3,{id:"features",children:"Features"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Interactive menu-driven interface"}),"\n",(0,r.jsx)(n.li,{children:"Automatic detection of migrator executable (Debug/Release)"}),"\n",(0,r.jsx)(n.li,{children:"Support for all database contexts"}),"\n",(0,r.jsx)(n.li,{children:"Configurable migration options"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"using-the-executor",children:"Using the Executor"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Navigate to the project root directory"}),"\n",(0,r.jsxs)(n.li,{children:["Run ",(0,r.jsx)(n.code,{children:"MigratorExecutor.bat"})]}),"\n",(0,r.jsx)(n.li,{children:"Follow the interactive prompts:"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"available-options",children:"Available options:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Run migrations for ALL databases"}),"\n",(0,r.jsxs)(n.li,{children:["Run migrations for specific database:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Log Database"}),"\n",(0,r.jsx)(n.li,{children:"App Database"}),"\n",(0,r.jsx)(n.li,{children:"IDP Configuration Database"}),"\n",(0,r.jsx)(n.li,{children:"IDP Persisted Grants Database"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Run with custom flags"}),"\n",(0,r.jsx)(n.li,{children:"Exit"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"for-each-option-you-can-configure",children:"For each option, you can configure:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Database recreation (--r)"}),"\n",(0,r.jsx)(n.li,{children:"Initial data seeding (--s)"}),"\n",(0,r.jsx)(n.li,{children:"Verbose logging (--v)"}),"\n",(0,r.jsx)(n.li,{children:"Sample data inclusion (--d)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"manual-command-usage",children:"Manual Command Usage"}),"\n",(0,r.jsx)(n.h3,{id:"run-generate-hangfire-migrations",children:"Run generate hangfire migrations"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"UW.Platform.Migrator.exe hangfire\n"})}),"\n",(0,r.jsx)(n.h3,{id:"run-migration-using-cmd",children:"Run migration using cmd"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"UW.Platform.Migrator.exe apply --database all --r --s --v --d\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"r: Recreate database"}),"\n",(0,r.jsx)(n.li,{children:"s: Seed Data"}),"\n",(0,r.jsx)(n.li,{children:"v: Verbose"}),"\n",(0,r.jsx)(n.li,{children:"d: Seed Sample Data"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"add-new-migration",children:"Add new migration"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["To add a new migration called ",(0,r.jsx)(n.code,{children:"InitialMigration"})," for the ",(0,r.jsx)(n.code,{children:"LogDbContext"})," we need to run the following command"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'dotnet ef migrations add "InitialMigration" --context LogDbContext --project src\\UW.Platform.Migrator --startup-project src\\UW.Platform.Migrator --output-dir Data\\LogDb\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["To add a new migration called ",(0,r.jsx)(n.code,{children:"InitialMigration"})," for the ",(0,r.jsx)(n.code,{children:"AppDbContext"})," we need to run the following command"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'dotnet ef migrations add "InitialMigration" --context AppDbContext --project src\\UW.Platform.Migrator --startup-project src\\UW.Platform.Migrator --output-dir Data\\AppDb\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["To add a new migration called ",(0,r.jsx)(n.code,{children:"InitialMigration"})," for the ",(0,r.jsx)(n.code,{children:"ConfigurationDbContext"})," (IDP) we need to run the following command"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'dotnet ef migrations add "InitialMigration" --context ConfigurationDbContext --project src\\UW.Platform.Migrator --startup-project src\\UW.Platform.Migrator --output-dir Data\\IDP\\ConfigurationDb\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["To add a new migration called ",(0,r.jsx)(n.code,{children:"InitialMigration"})," for the ",(0,r.jsx)(n.code,{children:"PersistedGrantDbContext"})," (IDP) we need to run the following command"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'dotnet ef migrations add "InitialMigration" --context PersistedGrantDbContext --project src\\UW.Platform.Migrator --startup-project src\\UW.Platform.Migrator --output-dir Data\\IDP\\PersistedGrantDb\n'})}),"\n",(0,r.jsx)(n.h3,{id:"remove-last-generated-migration",children:"Remove last generated migration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dotnet ef migrations remove --context AppDbContext --project src\\UW.Platform.Migrator --startup-project src\\UW.Platform.Migrator\n"})}),"\n",(0,r.jsx)(n.h3,{id:"apply-pending-migrations",children:"Apply pending migrations"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dotnet ef database update --context AppDbContext --project src\\UW.Platform.Migrator --startup-project src\\UW.Platform.Migrator\n"})}),"\n",(0,r.jsx)(n.h3,{id:"generate-sql-script-for-all-migrations",children:"Generate SQL script for all migrations"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"Script-Migration -StartupProject src\\UW.Platform.Migrator -Context LogDbContext\n"})}),"\n",(0,r.jsx)(n.h3,{id:"generate-sql-script-for-specific-migrations",children:"Generate SQL script for specific migrations"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"Script-Migration -StartupProject src\\UW.Platform.Migrator -From 'AddProviderNumberToChat' -To 'AddMessageSidAndState' -Context AppDbContext\n"})}),"\n",(0,r.jsx)(n.h2,{id:"database-contexts",children:"Database Contexts"}),"\n",(0,r.jsx)(n.h4,{id:"our-platform-uses-multiple-database-contexts",children:"Our platform uses multiple database contexts:"}),"\n",(0,r.jsxs)(n.h3,{id:"1-logdbcontext",children:["1. ",(0,r.jsx)(n.strong,{children:"LogDbContext"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Purpose: Handles logging and audit data"}),"\n",(0,r.jsxs)(n.li,{children:["Location: ",(0,r.jsx)(n.code,{children:"Data\\LogDb"})]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"2-appdbcontext",children:["2. ",(0,r.jsx)(n.strong,{children:"AppDbContext"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Purpose: Main application data"}),"\n",(0,r.jsxs)(n.li,{children:["Location: ",(0,r.jsx)(n.code,{children:"Data\\AppDb"})]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"3-configurationdbcontext",children:["3. ",(0,r.jsx)(n.strong,{children:"ConfigurationDbContext"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Purpose: Identity Provider configuration"}),"\n",(0,r.jsxs)(n.li,{children:["Location: ",(0,r.jsx)(n.code,{children:"Data\\IDP\\ConfigurationDb"})]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"4-persistedgrantdbcontext",children:["4. ",(0,r.jsx)(n.strong,{children:"PersistedGrantDbContext"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Purpose: Identity Provider tokens and grants"}),"\n",(0,r.jsxs)(n.li,{children:["Location: ",(0,r.jsx)(n.code,{children:"Data\\IDP\\PersistedGrantDb"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h4,{id:"common-issues-and-solutions",children:"Common issues and solutions:"}),"\n",(0,r.jsx)(n.h3,{id:"1-migration-fails-to-apply",children:"1. Migration fails to apply"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Ensure database connection is valid"}),"\n",(0,r.jsx)(n.li,{children:"Check for pending transactions"}),"\n",(0,r.jsx)(n.li,{children:"Verify correct context is specified"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"2-conflicting-migrations",children:"2. Conflicting migrations"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Remove last migration if not applied"}),"\n",(0,r.jsx)(n.li,{children:"Ensure all developers are synchronized"}),"\n",(0,r.jsx)(n.li,{children:"Use source control to track migration files"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"3-migratorexecutorbat-issues",children:"3. MigratorExecutor.bat issues"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Ensure the script is in the project root directory"}),"\n",(0,r.jsx)(n.li,{children:"Check if the migrator executable exists in Debug or Release folders"}),"\n",(0,r.jsx)(n.li,{children:"Verify execution permissions"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(n.h3,{id:"1-naming-conventions",children:"1. Naming Conventions"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Use descriptive names for migrations"}),"\n",(0,r.jsxs)(n.li,{children:["Follow the format: ",(0,r.jsx)(n.code,{children:"YYYYMMDD_Description"})]}),"\n",(0,r.jsxs)(n.li,{children:["Example: ",(0,r.jsx)(n.code,{children:"20240317_AddUserProfileFields"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"2-version-control",children:"2. Version Control"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Always commit migration files"}),"\n",(0,r.jsx)(n.li,{children:"Include both Up() and Down() methods"}),"\n",(0,r.jsx)(n.li,{children:"Document breaking changes"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"3-testing",children:"3. Testing"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Test migrations on development first"}),"\n",(0,r.jsx)(n.li,{children:"Generate and review SQL scripts"}),"\n",(0,r.jsx)(n.li,{children:"Maintain test data sets"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"4-deployment",children:"4. Deployment"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Use idempotent scripts when possible"}),"\n",(0,r.jsx)(n.li,{children:"Schedule during low-traffic periods"}),"\n",(0,r.jsx)(n.li,{children:"Have rollback plans ready"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>o});var t=i(6540);const r={},s=t.createContext(r);function a(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);